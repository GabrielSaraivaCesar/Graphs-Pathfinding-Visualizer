<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="./src/css/main.css">
    <link rel="stylesheet" href="./src/css/matrix_size_input.css">
    <script src="./src/js/components/matrix_size_input.js" ></script>
    <script src="./src/js/components/searchable_select_input.js" ></script>
</head>
<body>
    <canvas id="graphs-canvas"></canvas>
    <div class="menu">
        <h3>Tamanho da Matriz</h3>
        <matrix-size-input id="matrix-size"></matrix-size-input>
        <vertical-spacing></vertical-spacing>
        <button onclick="generateChart()">Gerar Grafo</button>
        <vertical-spacing></vertical-spacing>
        <vertical-spacing></vertical-spacing>
        <h3>Algoritmo</h3>

        <div style="z-index: 6; position: relative;">
            <searchable-select-input id="initial-vertex" label="Vértice Inicial" options='[{"label": "v0-0", "value": "v0-0"}]'></searchable-select-input>
        </div>
        <vertical-spacing></vertical-spacing>
        <div style="z-index: 5; position: relative;">
            <searchable-select-input id="final-vertex" label="Vértice Final" options='[{"label": "v0-0", "value": "v0-0"}]'></searchable-select-input>
        </div>
        <vertical-spacing></vertical-spacing>
        <div class="input-multi-options">
            <div class="opt">
                <input id="carteiro-chines" type="radio" name="algorithm-choice" value="chinese-mailer" checked>
                <label for="carteiro-chines">Cart. Chin.</label>
            </div>
            <div class="opt">
                <input id="caixeiro-viajante" type="radio" name="algorithm-choice" value="traveler-selesman">
                <label for="caixeiro-viajante">Caix. Viag.</label>
            </div>
            <div class="opt">
                <input id="caminho-curto" type="radio" name="algorithm-choice" value="smaller-path">
                <label for="caminho-curto">Mais Curto</label>
            </div>
        </div>
        <vertical-spacing></vertical-spacing>
        <button onclick="executeAlgorithm()">Executar</button>
    </div>
</body>
</html>

<script src="./src/js/shared/constants.js"></script>
<script src="./src/js/wave_collapse_function.js"></script>
<script src="./src/js/libs/graph/graph.js"></script>
<script src="./src/js/libs/navigable-canvas/canvas.js"></script>
<script src="./src/js/main.js"></script>

<script type="module">
import {generateDijkstraTable} from './src/js/libs/graph/algorithms/dijkstra.js';
import {findsmallerPath} from './src/js/libs/graph/algorithms/smaller_path.js';
import {findChineseMailerPath} from './src/js/libs/graph/algorithms/chinese_mailer.js';
import {NotReachablePathException} from './src/js/libs/graph/algorithms/shared.js';

function updateVertexInputOptions() {
    let options = JSON.stringify(currentGraph.vertices.map(vertex => ({label: vertex.tag, value: vertex.tag})));
    document.getElementById("initial-vertex").setAttribute("options", options);
    document.getElementById("final-vertex").setAttribute("options", options);
}
updateVertexInputOptions();

window.generateChart = function () {
    let matrixSize = document.getElementById("matrix-size").value;
    currentGraph = generateNewScene(matrixSize);
    updateVertexInputOptions();
}

window.executeAlgorithm = async function () {
    scene.sceneObjects = scene.sceneObjects.filter(obj => {
        if (obj.tag.split("-")[0] === "path") {
            return false;
        }
        return true;
    })
    scene.draw();

    let startVertexTag = document.getElementById('initial-vertex').value;
    let endVertexTag = document.getElementById('final-vertex').value;
    let algorithmChoice = document.querySelector("[name='algorithm-choice']:checked").value;

    let startVertex = currentGraph.vertices.find(vertex => {
        return vertex.tag === startVertexTag;
    });


    let endVertex = currentGraph.vertices.find(vertex => {
        return vertex.tag === endVertexTag;
    });

    if (!startVertex) {
        console.error("Start vertex is not valid");
        return;
    }


    
    let path = null;
    if (algorithmChoice === "smaller-path") {
        path = findsmallerPath(currentGraph, startVertex, endVertex);
    } else if (algorithmChoice === "chinese-mailer") {
        path = await findChineseMailerPath(currentGraph, startVertex, endVertex);
    }

    drawPath("path-"+startVertex.tag+"-"+endVertex.tag, path.path)
    scene.draw();
    
}

function drawPath(name, path) {
    if (path.length === 0) return;
    const spacingFromCenter = 0;
    scene.addObject(name, () => {
        let startVertexFromPath = currentGraph.vertices.find(v => v.tag == path[0])
        let lastPos = {
            x: startVertexFromPath.posX,
            y: startVertexFromPath.posY,
        }
        path.forEach(vertexTag => {
            scene.context.beginPath();
            let currentVertex = currentGraph.vertices.find(v => v.tag == vertexTag);

            let from = {
                x: lastPos.x - spacingFromCenter,
                y: lastPos.y + spacingFromCenter,
            }
            let to = {
                x: currentVertex.posX - spacingFromCenter,
                y: currentVertex.posY + spacingFromCenter
            }
            scene.context.lineWidth = 5

            scene.context.moveTo(from.x, from.y);
            scene.context.lineTo(to.x, to.y);
            scene.context.stroke();
            scene.context.fill();
            scene.context.closePath();

            drawArrowhead(scene.context, from, to, 5)
            lastPos.x = currentVertex.posX;
            lastPos.y = currentVertex.posY;
            scene.context.lineWidth = 5
            scene.context.strokeStyle = "#168c69"
            scene.context.stroke();
            scene.context.closePath();
            scene.context.lineWidth = 1
        })
    });
    scene.draw();
}

function drawArrowhead(context, from, to, radius) {
	var x_center = to.x;
	var y_center = to.y;

	var angle;
	var x;
	var y;

	context.beginPath();

	angle = Math.atan2(to.y - from.y, to.x - from.x)
	x = radius * Math.cos(angle) + x_center;
	y = radius * Math.sin(angle) + y_center;

	context.moveTo(x, y);

	angle += (1.0/3.0) * (2 * Math.PI)
	x = radius * Math.cos(angle) + x_center;
	y = radius * Math.sin(angle) + y_center;

	context.lineTo(x, y);

	angle += (1.0/3.0) * (2 * Math.PI)
	x = radius *Math.cos(angle) + x_center;
	y = radius *Math.sin(angle) + y_center;

	context.lineTo(x, y);

	context.closePath();

	context.fill();
}

</script>